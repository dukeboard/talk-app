<!DOCTYPE html>
<html lang="en-us">
  <head>
	<meta charset="UTF-8">
	<title>Markdown Viewer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
	<link rel='stylesheet' type='text/css' href='bower_components/open-sans-fontface/open-sans.css'>
	<link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
	<link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  <style>
  body{
    background: #FFF;
	}
  #main-content2{
    padding: 5px;
  }
  .modalIcon {
    color: #CCC;
    margin: 5px;
  }
  .modalIcon:hover {
    color: #DF9D00;
    margin: 5px;
  }
  .modalContainer {
        overflow: auto;
  }
  #btn-close-modal {
                width:100%;
                text-align: center;
                cursor:pointer;
                color:#fff;
            }
    #btn-close-modal:hover {
      background-color: #DF9D00;
    }
  </style>
  <link rel="stylesheet" href="font-awesome-4.4.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="simplemde.min.css">
  <style>
  .CodeMirror .CodeMirror-code .cm-tag {
      color: #63a35c;
  }

  .CodeMirror .CodeMirror-code .cm-attribute {
      color: #795da3;
  }

  .CodeMirror .CodeMirror-code .cm-string {
      color: #183691;
  }
  </style>
	<script src="simplemde.min.js"></script>
  <script src="fa-icons.js"></script>
  <link rel="stylesheet" href="animate.css" />

  </head>
  <body>
    <script src="jquery-2.1.4.min.js"></script>
    <script src="modal/animatedModal.min.js"></script>

    <div id="animatedModal">
        <div class="close-animatedModal" id="btn-close-modal">CLOSE</div>
        <div class="modal-content" id="modal-content-elem"></div>
    </div>

	<section class="main-content2">
		<textarea id="demo2"></textarea>
	</section>

	<script>
  var self = this;
	var simplemde = new SimpleMDE({
		element: document.getElementById("demo2"),
		spellChecker: true,
    status: false,
    toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|"]
	});
	simplemde.codemirror.setOption("fullScreen", true);
	simplemde.codemirror.on("change", function(){
    var currentValue = simplemde.value();
		parent.notifySlideUpdate(currentValue);
	});

  var toolBar = document.getElementsByClassName("editor-toolbar");
  var divToolBar = toolBar[0];

  var newSelector = document.createElement('div');
  newSelector.style.width = "50px";
  newSelector.style['margin-left'] = "5px";
  newSelector.id= "style.selector";
  newSelector.style.display = "inline-block";

  var fontSelector = document.createElement('a');
  fontSelector.style.display = "inline-block";
  fontSelector.innerHTML = '<span class="fa fa-plus-circle"></span>';
  fontSelector.href='#animatedModal';
  fontSelector.id='openModalBt';

  var modalTxt = "<div class='modalContainer'>";
  for(var i=0;i<faicons.length;i++){
    modalTxt += '<a href="#" class="modalIconLink"><span style="font-size:25px;" class="modalIcon fa '+faicons[i]+'"></span></a>';
  }
  modalTxt += '</div>';
  document.getElementById('modal-content-elem').innerHTML = modalTxt;

  divToolBar.appendChild(fontSelector);
  divToolBar.appendChild(newSelector);
  $("#openModalBt").animatedModal({animatedIn:'bounceIn',animatedOut:'bounceOut'});
  $(".modalIconLink").each(function(index,elem){
    elem.onclick = function(cc){
        var fontElemName = cc.srcElement.classList[2];
        var editor = simplemde.codemirror;
        editor.replaceSelection(":"+fontElemName+":", "end");
        $('.close-animatedModal').click();
    };
  });

  var selectList = document.createElement("select");
  var option = document.createElement("option");
      option.value = "slide";
      option.text = "default";
      selectList.appendChild(option);
  var option = document.createElement("option");
    option.value = "shout"
    option.text = "shout";
    selectList.appendChild(option);
  var option = document.createElement("option");
    option.value = "cover";
    option.text = "cover";
    selectList.appendChild(option);
  newSelector.appendChild(selectList);

/*
  var selectFontList = document.createElement("select");
  for(var i=0;i<faicons.length;i++){
    var option = document.createElement("option");
        option.value = faicons[i];
        option.class = "fa fa-flag";
        option.text = '<span class="fa '+faicons[i]+'"></span>';
        selectFontList.appendChild(option);
  }
  fontSelector.appendChild(selectFontList);
*/
  selectList.onchange = function(e) {
    parent.notifySlideTypeUpdate(selectList.value);
  }
  /*
  selectFontList.onchange = function(e) {
    console.log("insert ",selectFontList.value);
  }*/

	function setContent(content, type){
		simplemde.value(content);
    if(type != undefined){
      selectList.value = type;
    } else {
      selectList.value = 'slide';
    }
	}

  var allowedTypes = [
      'image/jpeg',
      'image/png',
      'image/jpg',
      'image/gif'
    ];


  function isFileAllowed(file){
    if (self.allowedTypes.indexOf('*') === 0){
      return true;
    } else {
      return self.allowedTypes.indexOf(file.type) >= 0;
    }
  }

  function decodeBase64Image(dataString) {
    var matches = dataString.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),response = {};
    if (matches.length !== 3) {
      return new Error('Invalid input string');
    }
    response.type = matches[1];
    response.data = new parent.Buffer(matches[2], 'base64');
    return response;
  }

  var el = simplemde.codemirror.getWrapperElement();
  el.addEventListener('paste', function(e) {
      e.preventDefault();
      if(parent.handler.getCurrentDir()==undefined){
        parent.handler.showImportImageError();
        return;
      }
      var clipboardData = e.clipboardData,items;
      if (typeof clipboardData === "object") {
        items = clipboardData.items || clipboardData.files || [];
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          if (self.isFileAllowed(item)) {
            var extension = 'png';
            if (item.name) {
                var fileNameMatches = item.name.match(/\.(.+)$/);
                if (fileNameMatches) {
                    extension = fileNameMatches[1];
                }
            }
            var remoteFilename = "images/imported-" + Date.now() + "." + extension;
            var file = item.getAsFile();
            var reader = new FileReader();
            reader.onload = function(event){
                  var imageBuffer = self.decodeBase64Image(event.target.result);
                  parent.fs.writeFile(parent.handler.getCurrentDir()+'/'+remoteFilename, imageBuffer.data,'binary', function(err){
                    if(err){
                      console.error(err);
                    } else {
                      var newContent = '<img src="$ROOT/'+remoteFilename+'" />';
                      self.simplemde.codemirror.replaceSelection("\n"+newContent+"\n", "end");

                      //self.simplemde.codemirror.setValue(self.simplemde.codemirror.getValue() + "\n"+newContent+"\n");
                    }
                  });
            }; // data url
            reader.readAsDataURL(file);
          }
        }
      }
    }, false);

  simplemde.codemirror.on("drop",function(editor,e){
    e.preventDefault();
    if(parent.handler.getCurrentDir()==undefined){
      parent.handler.showImportImageError();
      return;
    }
    items = e.dataTransfer.items || e.dataTransfer.files || [];
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      if (self.isFileAllowed(item)) {
        var extension = 'png';
        if (item.name) {
            var fileNameMatches = item.name.match(/\.(.+)$/);
            if (fileNameMatches) {
                extension = fileNameMatches[1];
            }
        }
        var remoteFilename = "images/imported-" + Date.now() + "." + extension;
        var file = item.getAsFile();
        var reader = new FileReader();
        reader.onload = function(event){
              var imageBuffer = self.decodeBase64Image(event.target.result);
              parent.fs.writeFile(parent.handler.getCurrentDir()+'/'+remoteFilename, imageBuffer.data,'binary', function(err){
                if(err){
                  console.error(err);
                } else {
                  var newContent = '<img src="$ROOT/'+remoteFilename+'" />';
                  self.simplemde.codemirror.replaceSelection("\n"+newContent+"\n", "end");
                  //self.simplemde.codemirror.setValue(self.simplemde.codemirror.getValue() + "\n"+newContent+"\n");
                }
              });
        }; // data url
        reader.readAsDataURL(file);
      }
    }
  });
	</script>
  </body>
</html>
