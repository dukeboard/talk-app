<!DOCTYPE HTML>
<html lang="en">
<head>
  <title>Talk</title>
	<meta charset="utf-8">
  <style>
   #codeFrame {
      float:left;
      width:0%;
      height:100%;
    }
    #rightFrame {
     float:right;
      width:100%;
      height:100%;
    }
	body,html{
	  overflow:hidden;
    height:100%;
    width:100%;
	}
	body{
		margin: 0 0 0 0;
    background: #333;
	}
  #holder { border: 7px dashed #ccc; width: 300px; height: 300px; margin: 20px auto;border-radius:7px;}
  #holder.hover { border: 7px dashed #DF9D00;border-radius:7px;}
  </style>
  <script>
    var handler = require('remote').getGlobal('handler');
    var mainWindow = require('remote').getGlobal('mainWindow');

    window.addEventListener('beforeunload', function(ev) {
      if (handler.edited()) {
          if (handler.edited()) {
             console.log("ForbidToClose!");
              ipc.send("window-close-click");
              ev.returnValue = 'false';
          }
      }
    });

    var ipc = require('ipc');
    var fs = require('fs');
    var isEditMode = false;
    var self = this;
    var viewerPayload = fs.readFileSync(__dirname+'/viewer.html','utf-8');
    function notifySlideUpdate(rawContent){
      //var viewerWindow = document.getElementById('rightFrame').contentWindow;
      setTimeout(function(){
        var csi = handler.getSelectedSlide();
        if(csi != undefined && csi > -1){
          var newPayload = handler.updateSlide(mainWindow,csi,rawContent);
          var viewerDocument = document.getElementById('rightFrame').contentDocument;
          var wrapper = viewerDocument.getElementById('slide_'+csi+'_wrap');
          wrapper.innerHTML = newPayload;
        }
      },0);
    }
    function notifySlideTypeUpdate(newType){
      //var viewerWindow = document.getElementById('rightFrame').contentWindow;
      setTimeout(function(){
        var csi = handler.getSelectedSlide();
        if(csi != undefined && csi > -1){
          handler.updateSlideType(mainWindow,csi,newType);
          var viewerDocument = document.getElementById('rightFrame').contentDocument;
          var wrapper = viewerDocument.getElementById('slide_'+csi);
          if(newType == 'slide'){
            wrapper.classList.remove('shout');
            wrapper.classList.remove('cover');
          } else {
            if(newType == 'shout'){
              wrapper.classList.remove('cover');
              wrapper.classList.add('shout');
            } else if(newType == 'cover'){
              wrapper.classList.remove('shout');
              wrapper.classList.add('cover');
            }
          }
          if(newType != 'slide'){
            wrapper.classList = 'slide '+newType;
          } else {
            wrapper.classList = 'slide';
          }
        }
      },0);
    }

    function notifySlideChange(currentSlideId){
      handler.setCurrentSelected(currentSlideId);
      if(self.isEditMode){
        if(currentSlideId != -1){
          self.lastEditedSlide = currentSlideId;
          var payload = handler.slideRaw(currentSlideId);
          var slideType = handler.slideType(currentSlideId);
          var viewerWindow = document.getElementById('codeFrame').contentWindow;
          viewerWindow.setContent(payload, slideType);
        }
      }
    }
    ipc.on('toggleEdit', function() {
      var rightFrame = document.getElementById('rightFrame');
      if(rightFrame){
        var viewerWindow = document.getElementById('rightFrame').contentWindow;
        var currentSlideId = handler.getSelectedSlide();
        if(currentSlideId != -1){
          var payload = handler.slideRaw(currentSlideId);
          var slideType = handler.slideType(currentSlideId);
          var viewerWindowCode = document.getElementById('codeFrame').contentWindow;
          viewerWindowCode.setContent(payload,slideType);
        }
        self.isEditMode = !self.isEditMode;
        if(self.isEditMode){
          viewerWindow.forceSlideMode();
          document.getElementById("codeFrame").style.width = "45%";
          document.getElementById("rightFrame").style.width = "55%";
          document.getElementById("codeFrame").focus();
          window.dispatchEvent(new Event('resize'));
        } else {
          document.getElementById("codeFrame").style.width = "0";
          document.getElementById("rightFrame").style.width = "100%";
          document.getElementById("rightFrame").focus();
          window.dispatchEvent(new Event('resize'));
        }
      }
    });
    ipc.on('slideModel', function(content) {
        var holder = document.getElementById('holder');
        if(holder){
          document.body.removeChild(holder);
        }
        //reset potentially leftFrame
        if(self.isEditMode){
          self.isEditMode = false;
          document.getElementById("codeFrame").style.width = "0";
          document.getElementById("rightFrame").style.width = "100%";
        }
        var rightFrame = document.getElementById('rightFrame');
        if(rightFrame){
           document.body.removeChild(rightFrame);
        }
        var newRightFrame = document.createElement('iframe');
        newRightFrame.id = 'rightFrame';
        newRightFrame.setAttribute('frameborder', 0);
        document.body.appendChild(newRightFrame);
        var dynamicPayload = viewerPayload.replace('{{content}}',content);
        var currentSlide = handler.getSelectedSlide();
        if(currentSlide!=undefined && currentSlide != -1){
          dynamicPayload = dynamicPayload.replace('{{selected}}',currentSlide);
        } else {
          dynamicPayload = dynamicPayload.replace('{{selected}}',0);
        }
        var dstDoc = newRightFrame.contentDocument;
        if(dstDoc == undefined){
          if(newRightFrame.contentWindow != undefined){
            dstDoc = newRightFrame.contentWindow.document;
          }
        }
        if(dstDoc){
          dstDoc.write(dynamicPayload);
          dstDoc.close();
        }
        newRightFrame.focus();
        //rightFrame.src = 'data:text/html;charset=utf-8,' + escape(dynamicPayload);
    });
  </script>
</head>
<body>
  <iframe id="codeFrame" src="static/editor/index.html" frameborder="0"></iframe>

  <div id="holder">
    <center><b style="color:#CCC;font-size:20px;"><br />To start...<br />drag a file here<br /> or open a talk CMD+O <br />or create a new one CMD+N</b></center>
  </div>

<!--
  <iframe id="rightFrame" frameborder="0"></iframe>
-->
  <!--
  <webview id="codeFrame" src="editor.html" nodeintegration></webview>
  <webview id="rightFrame" src="viewer.html" nodeintegration></webview>
  -->
<script>
window.ondragover = function(e) { e.preventDefault(); return false };
window.ondrop = function(e) { e.preventDefault(); return false };
var holder = document.getElementById('holder');
holder.ondragover = function () { this.className = 'hover'; return false; };
holder.ondragleave = function () { this.className = ''; return false; };
holder.ondrop = function (e) {
  e.preventDefault();
  for (var i = 0; i < e.dataTransfer.files.length; ++i) {
    var ext = e.dataTransfer.files[i].name.split('.').pop();
    if(ext =='talk'){
      handler.openModel(mainWindow,e.dataTransfer.files[i].path);
      mainWindow.focus();
      return false;
    }
  }
  return false;
};
</script>

</body>
</html>
