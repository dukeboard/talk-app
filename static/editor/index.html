<!DOCTYPE html>
<html lang="en-us">
  <head>
	<meta charset="UTF-8">
	<title>Markdown Viewer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
	<link rel='stylesheet' type='text/css' href='bower_components/open-sans-fontface/open-sans.css'>
	<link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
	<link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  <style>
  body{
    background: #FFF;
	}
  #main-content2{
    padding: 5px;
  }
  </style>
  </head>
  <body>
	<section class="main-content2">
		<textarea id="demo2"></textarea>
	</section>
	<link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="simplemde.min.css">
	<script src="simplemde2.min.js"></script>
	<script>
  var self = this;
	var simplemde = new SimpleMDE({
		element: document.getElementById("demo2"),
		spellChecker: true,
      	status: false,
     	toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "|"]
	});
	simplemde.codemirror.setOption("fullScreen", true);
	simplemde.codemirror.on("change", function(){
    var currentValue = simplemde.value();
		parent.notifySlideUpdate(currentValue);
	});
	function setContent(content){
		simplemde.value(content);
	}

  var allowedTypes = [
      'image/jpeg',
      'image/png',
      'image/jpg',
      'image/gif'
    ];


  function isFileAllowed(file){
    if (self.allowedTypes.indexOf('*') === 0){
      return true;
    } else {
      return self.allowedTypes.indexOf(file.type) >= 0;
    }
  }

  function decodeBase64Image(dataString) {
    var matches = dataString.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),response = {};
    if (matches.length !== 3) {
      return new Error('Invalid input string');
    }
    response.type = matches[1];
    response.data = new parent.Buffer(matches[2], 'base64');
    return response;
  }

  var el = simplemde.codemirror.getWrapperElement();
  el.addEventListener('paste', function(e) {
      e.preventDefault();
      if(parent.handler.getCurrentDir()==undefined){
        return;
      }
      var clipboardData = e.clipboardData,items;
      if (typeof clipboardData === "object") {
        items = clipboardData.items || clipboardData.files || [];
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          if (self.isFileAllowed(item)) {
            var extension = 'png';
            if (item.name) {
                var fileNameMatches = item.name.match(/\.(.+)$/);
                if (fileNameMatches) {
                    extension = fileNameMatches[1];
                }
            }
            var remoteFilename = "images/imported-" + Date.now() + "." + extension;
            var file = item.getAsFile();
            var reader = new FileReader();
            reader.onload = function(event){
                  var imageBuffer = self.decodeBase64Image(event.target.result);
                  parent.fs.writeFile(parent.handler.getCurrentDir()+'/'+remoteFilename, imageBuffer.data,'binary', function(err){
                    if(err){
                      console.error(err);
                    } else {
                      var newContent = '<img src="$ROOT/'+remoteFilename+'" />';
                      self.simplemde.codemirror.setValue(self.simplemde.codemirror.getValue() + "\n"+newContent+"\n");
                    }
                  });
            }; // data url
            reader.readAsDataURL(file);
          }
        }
      }
    }, false);

  simplemde.codemirror.on("drop",function(editor,e){
    e.preventDefault();
    if(parent.handler.getCurrentDir()==undefined){
      return;
    }
    items = e.dataTransfer.items || e.dataTransfer.files || [];
    for (var i = 0; i < items.length; i++) {
      var item = items[i];
      if (self.isFileAllowed(item)) {
        var extension = 'png';
        if (item.name) {
            var fileNameMatches = item.name.match(/\.(.+)$/);
            if (fileNameMatches) {
                extension = fileNameMatches[1];
            }
        }
        var remoteFilename = "images/imported-" + Date.now() + "." + extension;
        var file = item.getAsFile();
        var reader = new FileReader();
        reader.onload = function(event){
              var imageBuffer = self.decodeBase64Image(event.target.result);
              parent.fs.writeFile(parent.handler.getCurrentDir()+'/'+remoteFilename, imageBuffer.data,'binary', function(err){
                if(err){
                  console.error(err);
                } else {
                  var newContent = '<img src="$ROOT/'+remoteFilename+'" />';
                  self.simplemde.codemirror.setValue(self.simplemde.codemirror.getValue() + "\n"+newContent+"\n");
                }
              });
        }; // data url
        reader.readAsDataURL(file);
      }
    }
  });

	</script>
  </body>
</html>
